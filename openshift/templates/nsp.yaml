# Copyright 2021 The Province of British Columbia
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
apiVersion: template.openshift.io/v1
kind: Template
metadata:
  annotations:
    description: |
      The Network Security Policies (NSP) for the associated
      Platform Services RocketChat application.
  name: ${APP_NAME}-nsp
objects:
  - apiVersion: security.devops.gov.bc.ca/v1alpha1
    kind: ExternalNetwork
    metadata:
      name: all-things-external
      labels:
        app: ${APP_NAME}
    spec:
      # This name will be used internally by Aporeto; it should match
      # the `name` field in metadata above.
      description: |
        specify a custom external network that can be
        referenced by name.
      entries:
        - 192.0.73.2          # ? Located in S.F area
        - 142.34.208.210      # console.pathfinder.gov.bc.ca
        - 142.34.213.59       # BCGov
        - 51.81.0.0/16        # RC HQ
        - smtp.gov.bc.ca      # SMTP
        - apps.smtp.gov.bc.ca # SMTP
        - oidc.gov.bc.ca      # OIDC
        - dev.oidc.gov.bc.ca  # OIDC
        - test.oidc.gov.bc.ca # OIDC
        # - '*.svc.cloud.rocket.chat' # RC HQ
        # - 142.34.208.209      # OIDC
      servicePorts:
        - "tcp/80"
        - "tcp/443"
        - "tcp/25"
  - apiVersion: security.devops.gov.bc.ca/v1alpha1
    kind: NetworkSecurityPolicy
    metadata:
      name: db-to-db
      labels:
        app: ${APP_NAME}
    spec:
      description: |
        allow mongodb pods to talk to one another for
        replication etc.
      source:
        - - '$namespace=${NAMESPACE}'
          - '${DB_APO_IDENTIFIER}'
        - - '$namespace=${NAMESPACE}'
          - 'run=data-pump' 
      destination:
        - - '$namespace=${NAMESPACE}'
          - '${DB_APO_IDENTIFIER}'
  - apiVersion: security.devops.gov.bc.ca/v1alpha1
    kind: NetworkSecurityPolicy
    metadata:
      name: server-to-db
      labels:
        app: ${APP_NAME}
    spec:
      description: |
        allow rocket chat server to talk to the mongo
        db instances.
      source:
        - - '$namespace=${NAMESPACE}'
          - 'role=server'
      destination:
        - - '$namespace=${NAMESPACE}'
          - '${DB_APO_IDENTIFIER}'
  - apiVersion: security.devops.gov.bc.ca/v1alpha1
    kind: NetworkSecurityPolicy
    metadata:
      name: server-to-external
      labels:
        app: ${APP_NAME}
    spec:
      description: |
        allow rocket chat server to talk to external
        services
      source:
        - - '$namespace=${NAMESPACE}'
          - 'role=server'
      destination:
        - - '$namespace=${NAMESPACE}'
          - 'ext:name=all-things-external'
  - apiVersion: security.devops.gov.bc.ca/v1alpha1
    kind: NetworkSecurityPolicy
    metadata:
      name: datapump-to-external
      labels:
        app: ${APP_NAME}
    spec:
      description: |
        allow my data pump pot to talk to external
        services
      source:
        - - '$namespace=${NAMESPACE}'
          - 'debug.openshift.io/source-container=data-pump'
      destination:
        - - '$namespace=${NAMESPACE}'
          - 'ext:name=all-things-external'
  - apiVersion: security.devops.gov.bc.ca/v1alpha1
    kind: NetworkSecurityPolicy
    metadata:
      name: backup-to-mongodb
      labels:
        app: platsrv-registry
    spec:
      description: |
        allow the API to communicate with the NATS pod. This may not be
        required if you are using the production environment or, at the
        verry least, it will require modification.
      source:
        - - '$namespace=${NAMESPACE}'
          - 'role=backup'
      destination:
        - - '$namespace=${NAMESPACE}'
          - '${DB_APO_IDENTIFIER}'
parameters:
  - name: APP_NAME
    description: |
      The application name this NSP is assocated with.
    required: true
    value: rocketchat-nsp
  - name: NAMESPACE
    description: |
      The the name of the namespace the policy is being
      deployed to.
    required: true
  - name: DB_APO_IDENTIFIER
    description: |
      The Aporeto identifier used by Aporeto to identify the DB
      service.
    required: true
    value: "statefulset=mongodb"
  - name: BACKUP_CONTAINER_IDENTIFIER
    description: |
      The the name of the identifier used by Aporeto to
      isolate and identify the backup container pod(s).
    required: true
    value: "role=backup"