name: Promote Reggie API to Prod
on:
  workflow_dispatch:
jobs:
  set-image-id:
    runs-on: ubuntu-latest
    steps:

      - name: Log in to OpenShift
        run: |
          oc version
          oc login --token=${{ secrets.OpenShiftToken }} --server=${{ secrets.OpenShiftServerURL }}
          oc project 6e2f55-tools

      - name: Check out repo
        uses: actions/checkout@v2

      - name: Get ID of image with 'latest' tag
        id: get-image-id
        run: |
          export IMAGE_ID="$(oc -n 6e2f55-tools get imagestreamtag reggie-api:latest -o custom-columns=id:image.metadata.name --no-headers)"
          echo "::set-output name=imagesha::$IMAGE_ID"

      - name: Set image ID in kustomization.yaml
        run: |
          cd devops/env/prod
          kustomize edit set image "reggie-api=image-registry.openshift-image-registry.svc:5000/6e2f55-tools/reggie-api@${{ steps.get-image-id.outputs.imagesha }}"
          git commit -am "Update API image ID for Prod"
          git push origin
